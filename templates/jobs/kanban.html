{% extends "base.html" %}
{% load thai_filters %}

{% block title %}Kanban ออกแบบ — Print Shop Manager{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
{% endblock %}

{% block breadcrumb %}
  <span class="text-gray-500">Kanban</span>
  <span class="mx-1 text-gray-400">/</span>
  งานออกแบบ
{% endblock %}

{% block content %}
<div class="flex gap-4 h-full overflow-x-auto pb-4">

  {% for col in columns %}
  <div class="flex-shrink-0 w-72 flex flex-col">

    <!-- Column header -->
    <div class="flex items-center justify-between mb-3 px-1">
      <h2 class="text-sm font-semibold text-gray-700">{{ col.label }}</h2>
      <span class="text-xs px-2 py-0.5 rounded-full font-medium
        {% if col.color == 'blue' %}bg-blue-100 text-blue-700
        {% elif col.color == 'yellow' %}bg-yellow-100 text-yellow-700
        {% else %}bg-orange-100 text-orange-700{% endif %}">
        {{ col.jobs|length }}
      </span>
    </div>

    <!-- Drop zone -->
    <div id="col-{{ col.status }}"
         data-status="{{ col.status }}"
         class="flex-1 bg-gray-100 rounded-xl p-2 space-y-2 min-h-32 kanban-column">
      {% for job in col.jobs %}
        {% include "jobs/partials/kanban_card.html" with job=job today=today %}
      {% endfor %}
    </div>

  </div>
  {% endfor %}

</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const columns = document.querySelectorAll('.kanban-column');

    columns.forEach(function (col) {
      Sortable.create(col, {
        group: 'kanban',
        animation: 150,
        ghostClass: 'opacity-40',
        onEnd: function (evt) {
          const jobId = evt.item.dataset.jobId;
          const newStatus = evt.to.dataset.status;
          if (evt.from === evt.to) return;  // no column change, no status update needed

          htmx.ajax('POST', '/jobs/' + jobId + '/status/', {
            swap: 'none',
            values: { status: newStatus, csrfmiddlewaretoken: '{{ csrf_token }}' },
          });
        },
      });
    });
  });
</script>
{% endblock %}
