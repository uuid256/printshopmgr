{% extends "base.html" %}
{% load thai_filters %}

{% block title %}{{ customer.name }} — Print Shop Manager{% endblock %}
{% block breadcrumb %}
  <a href="{% url 'customers:list' %}" class="hover:text-indigo-600">ลูกค้า</a>
  <span class="mx-1 text-gray-400">/</span>
  {{ customer.name }}
{% endblock %}

{% block header_actions %}
<a href="{% url 'customers:edit' customer.pk %}"
   class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors">
  แก้ไข
</a>
<a href="{% url 'jobs:create' %}?customer={{ customer.pk }}"
   class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors">
  + รับงานใหม่
</a>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- Info card -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 space-y-4">
    <h2 class="text-base font-semibold text-gray-900">{{ customer.name }}</h2>

    <dl class="space-y-3 text-sm">
      <div class="flex justify-between">
        <dt class="text-gray-500">ประเภท</dt>
        <dd class="font-medium">{{ customer.customer_type.name }}</dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-gray-500">เบอร์โทร</dt>
        <dd class="font-medium">{{ customer.phone }}</dd>
      </div>
      {% if customer.email %}
      <div class="flex justify-between">
        <dt class="text-gray-500">อีเมล</dt>
        <dd class="font-medium">{{ customer.email }}</dd>
      </div>
      {% endif %}
      {% if customer.is_corporate %}
      <div class="flex justify-between">
        <dt class="text-gray-500">เลขผู้เสียภาษี</dt>
        <dd class="font-medium font-mono">{{ customer.tax_id|default:"—" }}</dd>
      </div>
      {% endif %}
      <div class="flex justify-between">
        <dt class="text-gray-500">เครดิต</dt>
        <dd>{% if customer.customer_type.credit_days %}{{ customer.customer_type.credit_days }} วัน{% else %}ชำระทันที{% endif %}</dd>
      </div>
      {% if customer.customer_type.discount_percent %}
      <div class="flex justify-between">
        <dt class="text-gray-500">ส่วนลดประจำ</dt>
        <dd class="text-green-700 font-medium">{{ customer.customer_type.discount_percent }}%</dd>
      </div>
      {% endif %}
    </dl>

    {% if customer.billing_address %}
    <div class="pt-2 border-t border-gray-100">
      <p class="text-xs text-gray-500 mb-1">ที่อยู่ออกใบกำกับ</p>
      <p class="text-sm text-gray-700 whitespace-pre-line">{{ customer.billing_address }}</p>
    </div>
    {% endif %}

    {% if customer.notes %}
    <div class="pt-2 border-t border-gray-100">
      <p class="text-xs text-gray-500 mb-1">หมายเหตุ</p>
      <p class="text-sm text-gray-700">{{ customer.notes }}</p>
    </div>
    {% endif %}
  </div>

  <!-- Job history -->
  <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
      <h3 class="text-sm font-semibold text-gray-700">ประวัติงาน</h3>
      <a href="{% url 'jobs:create' %}?customer={{ customer.pk }}"
         class="text-xs text-indigo-600 hover:text-indigo-800 font-medium">+ รับงานใหม่</a>
    </div>
    <table class="w-full text-sm">
      <thead>
        <tr class="text-xs text-gray-500 uppercase border-b border-gray-50 bg-gray-50">
          <th class="text-left px-4 py-3">#</th>
          <th class="text-left px-4 py-3">ชื่องาน</th>
          <th class="text-left px-4 py-3">สถานะ</th>
          <th class="text-right px-4 py-3">ราคา</th>
          <th class="text-left px-4 py-3 hidden sm:table-cell">วันที่รับ</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-50">
        {% for job in customer.jobs.all|slice:":20" %}
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-4 py-3">
            <a href="{% url 'jobs:detail' job.pk %}" class="text-indigo-600 font-medium hover:underline">#{{ job.pk }}</a>
          </td>
          <td class="px-4 py-3 text-gray-900">{{ job.title|truncatechars:40 }}</td>
          <td class="px-4 py-3">
            <span class="text-xs px-2 py-0.5 rounded-full font-medium
              {% if job.status == 'completed' %}bg-gray-100 text-gray-500
              {% elif job.status == 'ready' %}bg-green-100 text-green-700
              {% elif job.status == 'cancelled' %}bg-red-100 text-red-600
              {% else %}bg-yellow-100 text-yellow-700{% endif %}">
              {{ job.get_status_display }}
            </span>
          </td>
          <td class="px-4 py-3 text-right font-medium">{{ job.quoted_price|baht }}</td>
          <td class="px-4 py-3 text-gray-500 hidden sm:table-cell">{{ job.created_at|thai_date_short }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="px-4 py-8 text-center text-gray-400">ยังไม่มีงาน</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}
