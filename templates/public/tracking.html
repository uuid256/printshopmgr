{% load thai_filters %}
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô #{{ job.pk }} ‚Äî Print Shop Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Sarabun', sans-serif; } </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-lg mx-auto px-4 py-8 space-y-4">

    <div class="text-center mb-6">
      <span class="text-3xl">üñ®Ô∏è</span>
      <h1 class="text-xl font-bold mt-2">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>
    </div>

    <!-- Confirmation messages -->
    {% if approved %}
    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-center">
      <p class="text-green-800 font-semibold">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!</p>
      <p class="text-green-700 text-sm mt-1">‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
    </div>
    {% endif %}
    {% if revised %}
    <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 text-center">
      <p class="text-orange-800 font-semibold">‚úèÔ∏è ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß!</p>
      <p class="text-orange-700 text-sm mt-1">‡∏ó‡∏µ‡∏°‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ</p>
    </div>
    {% endif %}

    <!-- Job info card -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 space-y-4">
      <div>
        <p class="text-xs text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏á‡∏≤‡∏ô</p>
        <p class="font-bold text-lg">#{{ job.pk }} ‚Äî {{ job.title }}</p>
      </div>
      <div>
        <p class="text-xs text-gray-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
        <p class="font-medium">{{ job.product_type.name }}</p>
      </div>
      <div>
        <p class="text-xs text-gray-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
        <p class="font-bold text-indigo-700 text-lg">{{ job.get_status_display }}</p>
      </div>
      {% if job.due_date %}
      <div>
        <p class="text-xs text-gray-500">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</p>
        <p class="font-medium">{{ job.due_date|thai_date }}</p>
      </div>
      {% endif %}
    </div>

    <!-- Proof image gallery -->
    {% if proof_files %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <h2 class="text-sm font-semibold text-gray-700 mb-3">‡πÑ‡∏ü‡∏•‡πå proof ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ</h2>
      <div class="grid grid-cols-2 gap-2">
        {% for f in proof_files %}
        {% if f.is_image %}
        <a href="{{ f.file.url }}" target="_blank" class="block">
          <img src="{{ f.file.url }}" alt="proof"
               class="w-full h-32 object-cover rounded-lg border border-gray-100 hover:opacity-90 transition-opacity">
        </a>
        {% else %}
        <a href="{{ f.file.url }}" target="_blank"
           class="flex items-center justify-center h-32 bg-gray-50 rounded-lg border border-gray-100 hover:bg-gray-100 transition-colors">
          <div class="text-center">
            <span class="text-3xl">üìÑ</span>
            <p class="text-xs text-gray-600 mt-1 px-2 truncate">{{ f.filename }}</p>
          </div>
        </a>
        {% endif %}
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Approval action (only when awaiting_approval) -->
    {% if job.status == 'awaiting_approval' and not approved and not revised %}
    <div class="bg-white rounded-xl shadow-sm border border-blue-100 p-5" x-data="{ showRevision: false }">
      <h2 class="text-sm font-semibold text-gray-700 mb-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö proof ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•</h2>
      <p class="text-xs text-gray-500 mb-4">‡∏´‡∏≤‡∏Å‡∏û‡∏≠‡πÉ‡∏à‡∏Å‡∏±‡∏ö‡πÅ‡∏ö‡∏ö ‡∏Å‡∏î "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠<br>
        ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏Å‡∏î "‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>

      <!-- Approve form -->
      <form method="post" action="{% url 'public:approve' job.tracking_token %}" class="mb-3">
        {% csrf_token %}
        <input type="text" name="customer_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"
               class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-green-400">
        <button type="submit"
                class="w-full bg-green-600 text-white py-2.5 rounded-lg text-sm font-semibold hover:bg-green-700 transition-colors">
          ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ
        </button>
      </form>

      <!-- Toggle revision form -->
      <script>
        function toggleRevision() {
          const form = document.getElementById('revision-form');
          form.classList.toggle('hidden');
        }
      </script>
      <button type="button" onclick="toggleRevision()"
              class="w-full border border-orange-300 text-orange-700 py-2 rounded-lg text-sm font-medium hover:bg-orange-50 transition-colors">
        ‚úèÔ∏è ‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </button>

      <!-- Revision form (hidden by default) -->
      <div id="revision-form" class="hidden mt-3 pt-3 border-t border-gray-100">
        <form method="post" action="{% url 'public:revision' job.tracking_token %}">
          {% csrf_token %}
          <input type="text" name="customer_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"
                 class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-orange-400">
          <textarea name="notes" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç..." required
                    class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm mb-2 focus:outline-none focus:ring-2 focus:ring-orange-400 resize-none"></textarea>
          <button type="submit"
                  class="w-full bg-orange-600 text-white py-2.5 rounded-lg text-sm font-semibold hover:bg-orange-700 transition-colors">
            ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          </button>
        </form>
      </div>
    </div>
    {% endif %}

    <!-- Status history -->
    {% if history %}
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <h2 class="text-sm font-semibold text-gray-700 mb-3">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
      <ul class="space-y-2">
        {% for h in history %}
        <li class="flex items-start gap-3 text-sm">
          <span class="w-2 h-2 bg-indigo-400 rounded-full mt-1.5 flex-shrink-0"></span>
          <div>
            <span class="font-medium">{{ h.get_to_status_display }}</span>
            <span class="text-gray-400 ml-2">{{ h.changed_at|thai_date }}</span>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

  </div>
</body>
</html>
